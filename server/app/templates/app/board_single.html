{% extends "common/base.html" %}
{% load static %}


{% block content %}

<body class="single">

	<!-- Fake page loading -->
	<div id="fakeLoader"></div>

	<!-- Wrapper -->
	<div class="wrapper">

		<!-- Section -->
		<div class="container-fluid dark section no-padding">
			<div class="container">
				<div class="row">
					<div class="col-sm-12">
						<p class="author center-menu">Posted by {{ board.user.alias }} / <a href="#comments">{{ board_comments.count }} comments</a></p>
					</div>
				</div>
			</div>
		</div>

		<!-- Section: Board content-->
		<!-- Section -->
		<div class="container-fluid light section">
			<div class="container">
				<div class="row">
					<div class="col-sm-12 single-blog">
						{% if board.mainphoto%}
						<img src="{{ board.mainphoto.url }}" alt="Craft beer single blog post" />
						{%endif%}
						<header>
							<span class="date">{{ board.time|date:'y-m-d' }}</span>
							<h2 id="board_title">{{ board.title }}</h2>
						</header>
						<p id="board_content"> {{ board.content }}</p>
						<br>
						<br>
					</div>
					<br>
					<br>

					{% if request.session.user_id == board.user_id or request.session.user_id == 38 %}
						<span class="edit">
							<a href="/board/single/{{board.id}}/delete/" style="color: rgb(182, 156, 12);" >Delete</a> | <a href="/board/board_edit/?id={{ board.id }}" style="color: rgb(182, 156, 12);" >Edit</a>
						</span>
					{% endif %}
				</div>
			</div>
		</div>

		<!-- Section: Board comment-->
		<!-- Section -->
		<div class="container-fluid section">
			<div class="container">
				<div class="row">
					<div class="col-sm-12">
						<h3 id="comments">Comments</h3>
					</div>
					<div class="col-sm-12 user-comments">
						{% for board_comment in board_comments %}
						
						<div class="row scrollme animateme"  data-when="enter" data-from="0.75" data-to="0" data-opacity="0" data-translatey="75">
							<form id="board_comment">
								<div class="col-sm-11">
									<h5>{{ board_comment.user.alias }}</h5>
									<p>{{ board_comment.content }}</p>
									{% comment %} <p>Claritas est etiam processus dynamicus, qui sequitur mutationem consuetudium lectorum. Mirum est notare quam littera gothica, quam nunc putamus parum claram, anteposuerit litterarum formas humanitatis per seacula quarta decima et quinta decima.</p> {% endcomment %}
									{% if request.session.user_id == board_comment.user_id or request.session.user_id == 38 %}
										<span class="edit">
											<a href="/board/single/comments/{{board_comment.id}}/delete/" id="delete">Delete</a> | <a href="#" onClick="edit_button({{ board_comment.id }})">Edit</a>
										</span>
									{% endif %}
								</div>
							</form>
						</div>

						{% endfor %}
					</div>
				</div> 
			</div>
		</div>

		<!-- Section -->
		<div class="container-fluid light section no-padding">
			<div class="container">
				<div class="row">
					<div class="col-sm-6 dark matchHeight">
						<section class="alignMiddle padding-80-0 mobile-center">
							<header>
								<h1>Leave a</h1>
								<h2>Comment</h2>
							</header>
							<p>A tough one to drink. The use of molasses and licorice is simply overwhelming and without balance.</p>
						</section>
						<div class="grey-background" style="background-color: grey; background-size: cover;"></div>
					</div>
					<div class="col-sm-5 col-sm-push-1 matchHeight">
						<section class="alignMiddle padding-80-0">  
							<form class=" scrollme animateme" data-when="enter" data-from="1" data-to="0" data-opacity="0" data-scale="1.1">
								{% csrf_token %}
								{% comment %} <input type="text" name="name" placeholder="Name"> {% endcomment %}
								{% comment %} <input type="email" name="_replyto" placeholder="Email"> {% endcomment %}
								<textarea name="comment" placeholder="Comment" rows="5"></textarea>
								{% comment %} <a href="#" class="btn btn-default" id="comment" method="post"><span>Post comment</span></a>  {% endcomment %}
								<input type="submit" value="Post comment" class="btn btn-default" id="comment">
							</form>
						</section>
					</div> 
				</div>
			</div>
		</div>


	<!-- Modal -->
	<div class="modal fade" id="popupModal" tabindex="-1" role="dialog" aria-labelledby="popupModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="popupModalLabel" data-comment-id="">Modal title</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<textarea id="modal-message" rows="5"></textarea>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal" id="save_edit">OK</button>
				</div>
			</div>
		</div>
	</div>
</body>


<script type="text/javascript">
	$('#comment').click(function() {
		console.log("post-comment")
		$.ajax({
			url: '/board/single/?id={{ board_id }}', // views.py에서의 함수명
			data: $('form').serialize(),  // nickname=OOOO&password=XXXX
			type: 'POST',
			dataType: 'json',
			success: function(res) {
				if(res.result === "Success"){
					//$('#popupModalLabel').text(res.result);
					//$('#modal-message').text(res.messages);
					//$('#popupModal').modal('show');//now its working
					location.reload();
				}else if(res.result === "Fail"){
					if(res.messages === "go back"){
						window.location = '/login'
					}else {
						location.reload();
					}
				}
            },
			error: function(res) {
				// .....
			} 
		})


		return false;
	});

	let edit_button = (comment_id) => {
		console.log('edit_button', comment_id)

		$.ajax({
			url: `/board/edit/?id=${comment_id}`,
			data: $('form#board_comment').serialize(), // nickname=OOOO&password=XXXX
			type: 'get',
			success: function(res) {
					if(res.method === "get"){
						console.log("susccess, modal show")
						$('#popupModalLabel').text(res.nickname);
						$('#modal-message').text(res.content);
						$('#popupModal').modal('show');//now its working
						$('#popupModalLabel').attr('data-comment-id', comment_id)
						//location.reload();
				}
            },
			error: function(res) {
				// .....
			} 
		})
	}

	$('#save_edit').click(function() {
		comment_id = $('#popupModalLabel').attr('data-comment-id')
		console.log("save_edit", comment_id)

		$.ajax({
			url: `/board/edit/`,
			data: {
				'comment_id': comment_id,
				'content': $('#modal-message').val(),
			},  // nickname=OOOO&password=XXXX
			type: 'POST',
			dataType: 'json',
			success: function(res) {
				if(res.result === "Success"){
					location.reload();
				}else if(res.result === "Fail"){
					window.location.href = '/'
				}
            },
			error: function(res) {
				// .....
			} 
		})

		return false;
	});


	{% if messages%}
		window.location.replace(`/board/single/?id={{board_id}}`);	
	{%endif%}
</script>

{% endblock %}